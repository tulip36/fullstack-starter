#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.join(__dirname, '..');

// é¢œè‰²è¾“å‡º
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
};

function colorLog(color: keyof typeof colors, message: string) {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

// ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
function generateRandomString(length: number): string {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

// åˆ›å»º.env.localæ–‡ä»¶
function createEnvFile() {
  const envContent = `# Environment Variables
# Generated by bootstrap script on ${new Date().toISOString()}

# Application
NODE_ENV=development
NEXT_PUBLIC_APP_NAME=ä¸­é¤é¦†ç‚¹é¤ç³»ç»Ÿ
NEXT_PUBLIC_APP_DESCRIPTION=åœ¨ç¾å›½ä½¿ç”¨çš„ä¸­é¤é¦†ç‚¹é¤ç³»ç»Ÿ

# API Configuration
NEXT_PUBLIC_API_URL=http://localhost:3001
API_PORT=3001
WEB_PORT=3000

# Database
DATABASE_URL="file:./data/app.db"

# Authentication
JWT_SECRET=${generateRandomString(64)}
JWT_EXPIRES_IN=1h
REFRESH_TOKEN_EXPIRES_IN=7d

# Redis (Optional)
# REDIS_URL=redis://localhost:6379

# Email (Optional)
# SMTP_HOST=smtp.gmail.com
# SMTP_PORT=587
# SMTP_USER=your-email@gmail.com
# SMTP_PASS=your-app-password
# FROM_EMAIL=noreply@yourdomain.com

# File Upload
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/gif,application/pdf

# Logging
LOG_LEVEL=info
LOG_FILE=./logs/app.log

# Development
NEXT_PUBLIC_DEV_MODE=true
`;

  fs.writeFileSync(path.join(projectRoot, '.env.local'), envContent);
  colorLog('green', 'âœ“ åˆ›å»º .env.local æ–‡ä»¶');
}

// æ›´æ–°package.json
function updatePackageJson() {
  const packageJsonPath = path.join(projectRoot, 'package.json');
  const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));
  
  packageJson.name = 'chinese-restaurant-system';
  packageJson.description = 'åœ¨ç¾å›½ä½¿ç”¨çš„ä¸­é¤é¦†ç‚¹é¤ç³»ç»Ÿ';
  packageJson.author = 'jasonq';
  
  fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2));
  colorLog('green', 'âœ“ æ›´æ–° package.json');
}

// åˆ›å»ºå¿…è¦çš„ç›®å½•
function createDirectories() {
  const directories = [
    'logs',
    'uploads',
    'data',
  ];

  directories.forEach(dir => {
    const dirPath = path.join(projectRoot, dir);
    if (!fs.existsSync(dirPath)) {
      fs.mkdirSync(dirPath, { recursive: true });
      colorLog('green', `âœ“ åˆ›å»ºç›®å½•: ${dir}`);
    }
  });
}

// ä¸»åˆå§‹åŒ–å‡½æ•°
async function bootstrap() {
  colorLog('cyan', 'ğŸš€ æ¬¢è¿ä½¿ç”¨ Monorepo Bootstrap åˆå§‹åŒ–å·¥å…·');
  colorLog('yellow', 'æœ¬å·¥å…·å°†å¸®åŠ©æ‚¨å¿«é€Ÿé…ç½®é¡¹ç›®ç¯å¢ƒ\n');

  try {
    colorLog('bright', 'ğŸ“‹ é¡¹ç›®é…ç½®');
    console.log('é¡¹ç›®åç§°: ä¸­é¤é¦†ç‚¹é¤ç³»ç»Ÿ');
    console.log('é¡¹ç›®æè¿°: åœ¨ç¾å›½ä½¿ç”¨çš„ä¸­é¤é¦†ç‚¹é¤ç³»ç»Ÿ');
    console.log('ä½œè€…: jasonq');
    console.log('æ•°æ®åº“ç±»å‹: SQLite (å¼€å‘ç¯å¢ƒæ¨è)');
    console.log('å‰ç«¯ç«¯å£: 3000');
    console.log('åç«¯ç«¯å£: 3001');
    console.log('é‚®ç®±éªŒè¯: ç¦ç”¨');

    // å¼€å§‹é…ç½®
    colorLog('\nâš™ï¸ å¼€å§‹é…ç½®é¡¹ç›®...');

    // æ›´æ–°package.json
    updatePackageJson();

    // åˆ›å»º.env.localæ–‡ä»¶
    createEnvFile();

    // åˆ›å»ºå¿…è¦ç›®å½•
    createDirectories();

    colorLog('\nğŸ‰ é¡¹ç›®é…ç½®å®Œæˆï¼');
    colorLog('green', '\nğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ:');
    console.log('  pnpm install          # å®‰è£…ä¾èµ–');
    console.log('  pnpm db:generate      # ç”Ÿæˆæ•°æ®åº“å®¢æˆ·ç«¯');
    console.log('  pnpm db:migrate       # è¿è¡Œæ•°æ®åº“è¿ç§»');
    console.log('  pnpm db:seed          # åˆå§‹åŒ–ç§å­æ•°æ®');
    console.log('  pnpm dev              # å¯åŠ¨å¼€å‘æœåŠ¡å™¨');

  } catch (error) {
    colorLog('red', `\nâŒ åˆå§‹åŒ–å¤±è´¥: ${error}`);
    process.exit(1);
  }
}

// è¿è¡Œåˆå§‹åŒ–
bootstrap();